<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>wechat Documentation</title>
    <meta name="keywords" content="weixin,wechat" />
    <meta name="description" content="微信公共平台Node库" />
    <script src="assets/prettify.js"></script>
    <script src="assets/jquery-1.8.2.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.js"></script>
    <link rel="stylesheet" type="text/css" href="assets/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="assets/base.css" />
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="./index.html">wechat</a>
        </div>
      <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
          
            <li>
              <a href="./api.html">API Docs</a>
            </li>
          
          
          </ul>
        </div><!-- /.navbar-collapse -->
      </div>
    </nav>
    <header class="jumbotron subhead">
      <div class="container">
        <h1>wechat <small>Version: 1.2.2 By @Jackson Tian</small></h1>
        <p class="lead">
          微信公共平台Node库
        </p>
      </div>
    </header>

<div class="container content">
  <div class="row">
  	<div class="col-md-3">
      <ul class="nav nav-list bs-docs-sidenav affix">

  <li class="level_2">
    <a href="#index_模块状态" title="模块状态">
      <i class="icon-chevron-right"></i>模块状态
    </a>
  </li>

  <li class="level_2">
    <a href="#index_功能列表" title="功能列表">
      <i class="icon-chevron-right"></i>功能列表
    </a>
  </li>

  <li class="level_2">
    <a href="#index_Installation" title="Installation">
      <i class="icon-chevron-right"></i>Installation
    </a>
  </li>

  <li class="level_2">
    <a href="#index_Use with Connect/Express" title="Use with Connect/Express">
      <i class="icon-chevron-right"></i>Use with Connect/Express
    </a>
  </li>

  <li class="level_2">
    <a href="#index_Show cases" title="Show cases">
      <i class="icon-chevron-right"></i>Show cases
    </a>
  </li>

  <li class="level_2">
    <a href="#index_详细API" title="详细API">
      <i class="icon-chevron-right"></i>详细API
    </a>
  </li>

  <li class="level_2">
    <a href="#index_交流群" title="交流群">
      <i class="icon-chevron-right"></i>交流群
    </a>
  </li>

  <li class="level_2">
    <a href="#index_感谢" title="感谢">
      <i class="icon-chevron-right"></i>感谢
    </a>
  </li>

  <li class="level_2">
    <a href="#index_捐赠" title="捐赠">
      <i class="icon-chevron-right"></i>捐赠
    </a>
  </li>

  <li class="level_2">
    <a href="#index_License" title="License">
      <i class="icon-chevron-right"></i>License
    </a>
  </li>

</ul>

    </div>
    <div class="col-md-9">
      <section>
        <h1>wechat</h1>
<p>微信公共平台自动回复消息接口服务中间件</p><p><a href="./README.en.md">Wechat document in English</a></p><h2>模块状态</h2>
<ul>
<li><a href="http://badge.fury.io/js/wechat"><img src="https://badge.fury.io/js/wechat.png" alt="NPM version"></a></li>
<li><a href="https://travis-ci.org/node-webot/wechat"><img src="https://travis-ci.org/node-webot/wechat.png?branch=master" alt="Build Status"></a></li>
<li><a href="https://david-dm.org/node-webot/wechat"><img src="https://david-dm.org/node-webot/wechat.png" alt="Dependencies Status"></a></li>
<li><a href="https://coveralls.io/r/node-webot/wechat"><img src="https://coveralls.io/repos/node-webot/wechat/badge.png" alt="Coverage Status"></a></li>
</ul>
<h2>功能列表</h2>
<ul>
<li>自动回复（文本、图片、语音、视频、音乐、图文）</li>
<li>等待回复（用于调查问卷、问答等场景）</li>
<li>会话支持（创新功能）</li>
</ul>
<p>详细参见<a href="http://node-webot.github.io/wechat/api.html">API文档</a></p><ul>
<li>自动回复部分的Koa/Co版本：<a href="https://github.com/node-webot/co-wechat">https://github.com/node-webot/co-wechat</a></li>
<li>更多功能请前往：<a href="https://github.com/node-webot/wechat-api">https://github.com/node-webot/wechat-api</a>，Koa/Co版本：<a href="https://github.com/node-webot/co-wechat-api">https://github.com/node-webot/co-wechat-api</a></li>
<li>企业功能请前往：<a href="https://github.com/node-webot/wechat-enterprise">https://github.com/node-webot/wechat-enterprise</a></li>
<li>OAuth功能请前往：<a href="https://github.com/node-webot/wechat-oauth">https://github.com/node-webot/wechat-oauth</a></li>
</ul>
<h2>Installation</h2>
<pre><code class="lang-sh">$ npm install wechat
</code></pre>
<h2>Use with Connect/Express</h2>
<pre><code class="lang-js">var wechat = require(&#39;wechat&#39;);

app.use(connect.query()); // Or app.use(express.query());
app.use(&#39;/wechat&#39;, wechat(&#39;some token&#39;, function (req, res, next) {
  // 微信输入信息都在req.weixin上
  var message = req.weixin;
  if (message.FromUserName === &#39;diaosi&#39;) {
    // 回复屌丝(普通回复)
    res.reply(&#39;hehe&#39;);
  } else if (message.FromUserName === &#39;text&#39;) {
    //你也可以这样回复text类型的信息
    res.reply({
      content: &#39;text object&#39;,
      type: &#39;text&#39;
    });
  } else if (message.FromUserName === &#39;hehe&#39;) {
    // 回复一段音乐
    res.reply({
      type: &quot;music&quot;,
      content: {
        title: &quot;来段音乐吧&quot;,
        description: &quot;一无所有&quot;,
        musicUrl: &quot;http://mp3.com/xx.mp3&quot;,
        hqMusicUrl: &quot;http://mp3.com/xx.mp3&quot;,
        thumbMediaId: &quot;thisThumbMediaId&quot;
      }
    });
  } else {
    // 回复高富帅(图文回复)
    res.reply([
      {
        title: &#39;你来我家接我吧&#39;,
        description: &#39;这是女神与高富帅之间的对话&#39;,
        picurl: &#39;http://nodeapi.cloudfoundry.com/qrcode.jpg&#39;,
        url: &#39;http://nodeapi.cloudfoundry.com/&#39;
      }
    ]);
  }
}));
</code></pre>
<p>备注：token在微信平台的开发者中心申请</p><h3>回复消息</h3>
<p>当用户发送消息到微信公众账号，自动回复一条消息。这条消息可以是文本、图片、语音、视频、音乐、图文。详见：<a href="http://mp.weixin.qq.com/wiki/index.php?title=发送被动响应消息">官方文档</a></p><h4>回复文本</h4>
<pre><code class="lang-js">res.reply(&#39;Hello world!&#39;);
// 或者
res.reply({type: &quot;text&quot;, content: &#39;Hello world!&#39;});
</code></pre>
<h4>回复图片</h4>
<pre><code class="lang-js">res.reply({
  type: &quot;image&quot;,
  content: {
    mediaId: &#39;mediaId&#39;
  }
});
</code></pre>
<h4>回复语音</h4>
<pre><code class="lang-js">res.reply({
  type: &quot;voice&quot;,
  content: {
    mediaId: &#39;mediaId&#39;
  }
});
</code></pre>
<h4>回复视频</h4>
<pre><code class="lang-js">res.reply({
  type: &quot;video&quot;,
  content: {
    title: &#39;来段视频吧&#39;,
    description: &#39;女神与高富帅&#39;,
    mediaId: &#39;mediaId&#39;
  }
});
</code></pre>
<h4>回复音乐</h4>
<pre><code class="lang-js">res.reply({
  title: &quot;来段音乐吧&quot;,
  description: &quot;一无所有&quot;,
  musicUrl: &quot;http://mp3.com/xx.mp3&quot;,
  hqMusicUrl: &quot;http://mp3.com/xx.mp3&quot;,
  thumbMediaId: &quot;thisThumbMediaId&quot;
});
</code></pre>
<h4>回复图文</h4>
<pre><code class="lang-js">res.reply([
  {
    title: &#39;你来我家接我吧&#39;,
    description: &#39;这是女神与高富帅之间的对话&#39;,
    picurl: &#39;http://nodeapi.cloudfoundry.com/qrcode.jpg&#39;,
    url: &#39;http://nodeapi.cloudfoundry.com/&#39;
  }
]);
</code></pre>
<h3>OAuth</h3>
<p>OAuth功能请前往：<a href="https://github.com/node-webot/wechat-oauth">https://github.com/node-webot/wechat-oauth</a></p><h3>WXSession支持</h3>
<p>由于公共平台应用的客户端实际上是微信，所以采用传统的Cookie来实现会话并不现实，为此中间件模块在openid的基础上添加了Session支持。一旦服务端启用了<code>connect.session</code>中间件，在业务中就可以访问<code>req.wxsession</code>属性。这个属性与<code>req.session</code>行为类似。</p><pre><code class="lang-js">app.use(connect.cookieParser());
app.use(connect.session({secret: &#39;keyboard cat&#39;, cookie: {maxAge: 60000}}));
app.use(&#39;/wechat&#39;, wechat(&#39;some token&#39;, wechat.text(function (info, req, res, next) {
  if (info.Content === &#39;=&#39;) {
    var exp = req.wxsession.text.join(&#39;&#39;);
    req.wxsession.text = &#39;&#39;;
    res.reply(exp);
  } else {
    req.wxsession.text = req.wxsession.text || [];
    req.wxsession.text.push(info.Content);
    res.reply(&#39;收到&#39; + info.Content);
  }
})));
</code></pre>
<p><code>req.wxsession</code>与<code>req.session</code>采用相同的存储引擎，这意味着如果采用redis作为存储，这样<code>wxsession</code>可以实现跨进程共享。</p><h3>等待回复</h3>
<p>等待回复，类似于电话拨号业务。该功能在WXSession的基础上提供。需要为等待回复预置操作，中间件将其抽象为<code>List</code>对象，在提供服务前需要添加服务。</p><pre><code class="lang-js">var List = require(&#39;wechat&#39;).List;
List.add(&#39;view&#39;, [
  [&#39;回复{a}查看我的性别&#39;, function (info, req, res) {
    res.reply(&#39;我是个妹纸哟&#39;);
  }],
  [&#39;回复{b}查看我的年龄&#39;, function (info, req, res) {
    res.reply(&#39;我今年18岁&#39;);
  }],
  [&#39;回复{c}查看我的性取向&#39;, &#39;这样的事情怎么好意思告诉你啦- -&#39;]
]);
</code></pre>
<p>然后在业务中触发等待回复事务，如下示例，当收到用户发送<code>list</code>后，调用<code>res.wait(&#39;view&#39;)</code>进入事务<code>view</code>中。</p><pre><code class="lang-js">var app = connect();
app.use(connect.query());
app.use(connect.cookieParser());
app.use(connect.session({secret: &#39;keyboard cat&#39;, cookie: {maxAge: 60000}}));
app.use(&#39;/wechat&#39;, wechat(&#39;some token&#39;, wechat.text(function (info, req, res, next) {
  if (info.Content === &#39;list&#39;) {
    res.wait(&#39;view&#39;);
  } else {
    res.reply(&#39;hehe&#39;);
    // 或者中断等待回复事务
    // res.nowait(&#39;hehe&#39;);
  }
})));
</code></pre>
<p>用户将收到如下回复：</p><pre><code>回复a查看我的性别
回复b查看我的年龄
回复c查看我的性取向
</code></pre><p>用户回复其中的<code>a</code>、<code>b</code>、<code>c</code>将会由注册的方法接管回复。回复可以是一个函数，也可以是一个字符串：</p><pre><code class="lang-js">List.add(&#39;view&#39;, [
  [&#39;回复{a}查看我的性别&#39;, function (info, req, res, next) {
    res.reply(&#39;我是个妹纸哟&#39;);
  }],
  // 或者字符串
  [&#39;回复{c}查看我的性取向&#39;, &#39;这样的事情怎么好意思告诉你啦- -&#39;]
]);
</code></pre>
<p>如果用户触发等待回复事务后，没有按照<code>{}</code>中的进行回复，那么将会由原有的默认函数进行处理。在原有函数中，可以选择调用<code>res.nowait()</code>中断事务。<code>nowait()</code>除了能中断事务外，与<code>reply</code>的行为一致。</p><h2>Show cases</h2>
<h3>Node.js API自动回复</h3>
<p><img src="http://nodeapi.diveintonode.org/assets/qrcode.jpg" alt="Node.js API自动回复机器人"></p><p>欢迎关注。</p><p>代码：<a href="https://github.com/JacksonTian/api-doc-service">https://github.com/JacksonTian/api-doc-service</a></p><p>你可以在<a href="http://www.cloudfoundry.com/">CloudFoundry</a>、<a href="https://www.appfog.com/">appfog</a>、<a href="http://developer.baidu.com/wiki/index.php?title=docs/cplat/rt/node.js">BAE</a>等搭建自己的机器人。</p><h2>详细API</h2>
<p>原始API文档请参见：<a href="http://mp.weixin.qq.com/wiki/index.php?title=消息接口指南">消息接口指南</a>。</p><p>目前微信公共平台能接收到7种内容：文字、图片、音频、视频、位置、链接、事件。支持6种回复：纯文本、图文、音乐、音频、图片、视频。<br />针对目前的业务形态，发布了0.6.x版本，该版本支持六种内容分别处理，以保持业务逻辑的简洁性。</p><pre><code class="lang-js">app.use(&#39;/wechat&#39;, wechat(&#39;some token&#39;, wechat.text(function (message, req, res, next) {
  // message为文本内容
  // { ToUserName: &#39;gh_d3e07d51b513&#39;,
  // FromUserName: &#39;oPKu7jgOibOA-De4u8J2RuNKpZRw&#39;,
  // CreateTime: &#39;1359125035&#39;,
  // MsgType: &#39;text&#39;,
  // Content: &#39;http&#39;,
  // MsgId: &#39;5837397576500011341&#39; }
}).image(function (message, req, res, next) {
  // message为图片内容
  // { ToUserName: &#39;gh_d3e07d51b513&#39;,
  // FromUserName: &#39;oPKu7jgOibOA-De4u8J2RuNKpZRw&#39;,
  // CreateTime: &#39;1359124971&#39;,
  // MsgType: &#39;image&#39;,
  // PicUrl: &#39;http://mmsns.qpic.cn/mmsns/bfc815ygvIWcaaZlEXJV7NzhmA3Y2fc4eBOxLjpPI60Q1Q6ibYicwg/0&#39;,
  // MediaId: &#39;media_id&#39;,
  // MsgId: &#39;5837397301622104395&#39; }
}).voice(function (message, req, res, next) {
  // message为音频内容
  // { ToUserName: &#39;gh_d3e07d51b513&#39;,
  // FromUserName: &#39;oPKu7jgOibOA-De4u8J2RuNKpZRw&#39;,
  // CreateTime: &#39;1359125022&#39;,
  // MsgType: &#39;voice&#39;,
  // MediaId: &#39;OMYnpghh8fRfzHL8obuboDN9rmLig4s0xdpoNT6a5BoFZWufbE6srbCKc_bxduzS&#39;,
  // Format: &#39;amr&#39;,
  // MsgId: &#39;5837397520665436492&#39; }
}).video(function (message, req, res, next) {
  // message为视频内容
  // { ToUserName: &#39;gh_d3e07d51b513&#39;,
  // FromUserName: &#39;oPKu7jgOibOA-De4u8J2RuNKpZRw&#39;,
  // CreateTime: &#39;1359125022&#39;,
  // MsgType: &#39;video&#39;,
  // MediaId: &#39;OMYnpghh8fRfzHL8obuboDN9rmLig4s0xdpoNT6a5BoFZWufbE6srbCKc_bxduzS&#39;,
  // ThumbMediaId: &#39;media_id&#39;,
  // MsgId: &#39;5837397520665436492&#39; }
}).location(function (message, req, res, next) {
  // message为位置内容
  // { ToUserName: &#39;gh_d3e07d51b513&#39;,
  // FromUserName: &#39;oPKu7jgOibOA-De4u8J2RuNKpZRw&#39;,
  // CreateTime: &#39;1359125311&#39;,
  // MsgType: &#39;location&#39;,
  // Location_X: &#39;30.283950&#39;,
  // Location_Y: &#39;120.063139&#39;,
  // Scale: &#39;15&#39;,
  // Label: {},
  // MsgId: &#39;5837398761910985062&#39; }
}).link(function (message, req, res, next) {
  // message为链接内容
  // { ToUserName: &#39;gh_d3e07d51b513&#39;,
  // FromUserName: &#39;oPKu7jgOibOA-De4u8J2RuNKpZRw&#39;,
  // CreateTime: &#39;1359125022&#39;,
  // MsgType: &#39;link&#39;,
  // Title: &#39;公众平台官网链接&#39;,
  // Description: &#39;公众平台官网链接&#39;,
  // Url: &#39;http://1024.com/&#39;,
  // MsgId: &#39;5837397520665436492&#39; }
}).event(function (message, req, res, next) {
  // message为事件内容
  // { ToUserName: &#39;gh_d3e07d51b513&#39;,
  // FromUserName: &#39;oPKu7jgOibOA-De4u8J2RuNKpZRw&#39;,
  // CreateTime: &#39;1359125022&#39;,
  // MsgType: &#39;event&#39;,
  // Event: &#39;LOCATION&#39;,
  // Latitude: &#39;23.137466&#39;,
  // Longitude: &#39;113.352425&#39;,
  // Precision: &#39;119.385040&#39;,
  // MsgId: &#39;5837397520665436492&#39; }
})));
</code></pre>
<p>注意： <code>text</code>, <code>image</code>, <code>voice</code>, <code>video</code>, <code>location</code>, <code>link</code>, <code>event</code>方法请至少指定一个。<br />这六个方法的设计适用于按内容类型区分处理的场景。如果需要更复杂的场景，请使用第一个例子中的API。</p><h3>更简化的API设计</h3>
<p>示例如下：</p><pre><code class="lang-js">app.use(&#39;/wechat&#39;, wechat(&#39;some token&#39;).text(function (message, req, res, next) {
  // TODO
}).image(function (message, req, res, next) {
  // TODO
}).voice(function (message, req, res, next) {
  // TODO
}).video(function (message, req, res, next) {
  // TODO
}).location(function (message, req, res, next) {
  // TODO
}).link(function (message, req, res, next) {
  // TODO
}).event(function (message, req, res, next) {
  // TODO
}).middlewarify());
</code></pre>
<p>该接口从0.3.x提供。</p><h3>流程图</h3>
<p><img src="https://raw.github.com/node-webot/wechat/master/figures/wechat.png" alt="graph"></p><p>诸多细节由wechat中间件提供，用户只要关注蓝色部分的业务逻辑即可。</p><h2>交流群</h2>
<p>QQ群：157964097，使用疑问，开发，贡献代码请加群。</p><h2>感谢</h2>
<p>感谢以下贡献者：</p><pre><code>$ git summary

 project  : wechat
 repo age : 1 year, 10 months
 active   : 122 days
 commits  : 287
 files    : 33
 authors  :
   239  Jackson Tian  83.3%
    10  yelo          3.5%
     9  ifeiteng      3.1%
     4  realdog       1.4%
     4  Bruce Lee     1.4%
     3  Guo Yu        1.0%
     2  zhongao       0.7%
     2  Jesse Yang    0.7%
     2  Lu Jun        0.7%
     2  dan           0.7%
     1  Rogerz Zhang  0.3%
     1  Chen Wei      0.3%
     1  feichang.wyl  0.3%
     1  feit          0.3%
     1  Qun Lin       0.3%
     1  p13766        0.3%
     1  LiSheep       0.3%
     1  xianda        0.3%
     1  Lance Li      0.3%
     1  TooBug        0.3%
</code></pre><h2>捐赠</h2>
<p>如果您觉得Wechat对您有帮助，欢迎请作者一杯咖啡</p><p><img src="https://cloud.githubusercontent.com/assets/327019/2941591/2b9e5e58-d9a7-11e3-9e80-c25aba0a48a1.png" alt="捐赠wechat"></p><p>或者<a href="https://www.gittip.com/JacksonTian/"><img src="http://img.shields.io/gratipay/JacksonTian.svg" alt=""></a></p><h2>License</h2>
<p>The MIT license.</p>
      </section>
  
    </div>
  </div>
</div>
      <footer class="footer">
        <div class="container">
          <p class="pull-right">
            <a href="#">Back to top</a>
          </p>
          <p>此文档通过doxmate生成。主题借鉴Bootstrap API文档风格，注解基于<a href="https://github.com/visionmedia/dox">Dox</a>。欢迎关注doxmate作者<a href="http://weibo.com/shyvo" target="_blank">@朴灵</a></p>
          <ul class="footer-links">
            <li><a href="https://github.com/visionmedia/dox">Dox主页</a></li>
            <li><a href="http://html5ify.com/doxmate">Doxmate主页</a></li>
            <li><a href="https://github.com/JacksonTian/doxmate">Doxmate源码</a></li>
            <li><a href="https://github.com/JacksonTian/doxmate/issues?state=open">提交bug</a></li>
          </ul>
      </div>
    </footer>
    <script>
      $(function() {
        $('pre').addClass('prettyprint');
        $('td pre').removeClass('prettyprint');
        prettyPrint();
        var $window = $(window);
        $('.bs-docs-sidenav').affix({
          offset: {
            top: function () {
              return $window.width() <= 980 ? 290 : 210
            },
            bottom: 270
          }
        });
        $(".content").find('h1, h2, h3, h4, h5, h6').each(function () {
          var node = $(this);
          // 总是设置id
          node.attr("id", node.data('id') || "index_" + node.text());
          node.css("paddingTop", 50);
        });
      });
    </script>
  
  </body>
</html>

